/** * 组件管理服务 */import { loggerService } from '@logger'import {  ComponentConfig,  ComponentSettings,  DEFAULT_COMPONENT_SETTINGS,  ComfyUIComponentConfig,  JSComponentConfig,  JSComponentResult} from '@renderer/types/component'import type {  } from '@renderer/types/componentExport'import { generateAIPrompt, validateComponentConfig } from '@renderer/utils/componentConfig'import {  exportComponentToJSON,  validateImportData,  checkComponentConflicts,  generateNewId,  generateNewComponentName,  parseImportFile,  getExportFileName} from '@renderer/utils/componentExport'import store from '@renderer/store'import {  setComponentSettings,  setComponentEnabled,  updateComponentConfig,  resetComponentConfig} from '@renderer/store/settings'const logger = loggerService.withContext('ComponentService')export class ComponentService {  private static instance: ComponentService  public static getInstance(): ComponentService {    if (!ComponentService.instance) {      ComponentService.instance = new ComponentService()    }    return ComponentService.instance  }  /**   * 获取所有组件配置   */  getComponentSettings(): ComponentSettings {    const state = store.getState()    return state.settings.componentSettings || DEFAULT_COMPONENT_SETTINGS  }  /**   * 获取单个组件配置   */  getComponentConfig(id: string): ComponentConfig | null {    const settings = this.getComponentSettings()    return settings.components[id] || null  }  /**   * 获取启用的组件列表   */  getEnabledComponents(): ComponentConfig[] {    const settings = this.getComponentSettings()    return Object.values(settings.components).filter((component) => component.enabled)  }  /**   * 更新整个组件设置（用于导入或批量操作）   */  updateComponentSettings(settings: ComponentSettings) {    store.dispatch(setComponentSettings(settings))  }  /**   * 设置组件启用状态   */  setComponentEnabled(id: string, enabled: boolean): boolean {    try {      const config = this.getComponentConfig(id)      if (!config) {        logger.warn('Component not found:', { id })        return false      }      store.dispatch(setComponentEnabled({ id, enabled }))      logger.info('Component enabled state updated:', { id, enabled })      return true    } catch (error) {      logger.error('Failed to set component enabled state:', error as Error)      return false    }  }  /**   * 更新组件配置   */  updateComponentConfig(id: string, config: Partial<ComponentConfig>): boolean {    try {      const existingConfig = this.getComponentConfig(id)      if (!existingConfig) {        logger.warn('Component not found:', { id })        return false      }      // 验证更新后的配置      const updatedConfig = { ...existingConfig, ...config }      const validation = validateComponentConfig(updatedConfig)      if (!validation.valid) {        logger.warn('Invalid component config:', { errors: validation.errors })        return false      }      store.dispatch(updateComponentConfig({ id, config }))      logger.info('Component config updated:', { id, config })      return true    } catch (error) {      logger.error('Failed to update component config:', error as Error)      return false    }  }  /**   * 重置组件配置为默认值   */  resetComponentConfig(id: string): boolean {    try {      const defaultConfig = DEFAULT_COMPONENT_SETTINGS.components[id]      if (!defaultConfig) {        logger.warn('Default config not found for component:', { id })        return false      }      store.dispatch(resetComponentConfig(id))      logger.info('Component config reset to default:', { id })      return true    } catch (error) {      logger.error('Failed to reset component config:', error as Error)      return false    }  }  /**   * 生成组件的AI提示词   */  generateComponentPrompt(    id: string,    options?: {      includeExamples?: boolean      includeParameterDetails?: boolean      language?: 'zh-CN' | 'en-US'      format?: 'markdown' | 'plain'    }  ): string | null {    try {      const config = this.getComponentConfig(id)      if (!config) {        logger.warn('Component not found:', { id })        return null      }      const prompt = generateAIPrompt(config, {        includeExamples: true,        includeParameterDetails: true,        language: 'zh-CN',        format: 'markdown',        ...options      })      logger.info('Generated AI prompt for component:', { id })      return prompt    } catch (error) {      logger.error('Failed to generate component prompt:', error as Error)      return null    }  }  /**   * 生成所有启用组件的AI提示词   */  generateAllComponentsPrompt(options?: {    includeExamples?: boolean    includeParameterDetails?: boolean    language?: 'zh-CN' | 'en-US'    format?: 'markdown' | 'plain'  }): string {    try {      const enabledComponents = this.getEnabledComponents()      const language = options?.language || 'zh-CN'      const isZhCN = language === 'zh-CN'      let prompt = ''      if (options?.format === 'markdown') {        prompt += `# ${isZhCN ? 'Cherry Studio 内置组件使用指南' : 'Cherry Studio Built-in Components Guide'}\n\n`        prompt += `${isZhCN ? '以下是可用的内置组件及其使用方法：' : 'The following built-in components are available:'}\n\n`      } else {        prompt += `${isZhCN ? 'Cherry Studio 内置组件使用指南' : 'Cherry Studio Built-in Components Guide'}\n\n`      }      enabledComponents.forEach((component, index) => {        if (index > 0) {          prompt += '\n---\n\n'        }        prompt += this.generateComponentPrompt(component.id, options) || ''      })      logger.info('Generated AI prompt for all enabled components')      return prompt    } catch (error) {      logger.error('Failed to generate all components prompt:', error as Error)      return ''    }  }  /**   * 导出组件配置   */  exportComponentSettings(): string {    try {      const settings = this.getComponentSettings()      return JSON.stringify(settings, null, 2)    } catch (error) {      logger.error('Failed to export component settings:', error as Error)      return ''    }  }  /**   * 导入组件配置   */  importComponentSettings(jsonString: string): boolean {    try {      const settings = JSON.parse(jsonString) as ComponentSettings      // 基础验证      if (!settings.components || typeof settings.components !== 'object') {        logger.warn('Invalid component settings format')        return false      }      // 验证每个组件配置      for (const [id, config] of Object.entries(settings.components)) {        const validation = validateComponentConfig(config)        if (!validation.valid) {          logger.warn('Invalid component config during import:', { id, errors: validation.errors })          return false        }      }      store.dispatch(setComponentSettings(settings))      logger.info('Component settings imported successfully')      return true    } catch (error) {      logger.error('Failed to import component settings:', error as Error)      return false    }  }  /**   * 复制文本到剪贴板   */  async copyToClipboard(text: string): Promise<boolean> {    try {      await navigator.clipboard.writeText(text)      logger.info('Text copied to clipboard')      return true    } catch (error) {      logger.error('Failed to copy to clipboard:', error as Error)      return false    }  }  /**   * 保存文本为文件   */  async saveAsFile(content: string, filename: string): Promise<boolean> {    try {      // 使用 window.api 保存文件      const filePath = await window.api.file.save(filename, content, {        filters: [          { name: 'Markdown Files', extensions: ['md'] },          { name: 'Text Files', extensions: ['txt'] },          { name: 'JSON Files', extensions: ['json'] },          { name: 'All Files', extensions: ['*'] }        ]      })      if (filePath) {        logger.info('File saved successfully:', { filePath })        return true      } else {        logger.warn('File save cancelled')        return false      }    } catch (error) {      logger.error('Failed to save file:', error as Error)      return false    }  }  /**   * 检查组件是否可用   */  isComponentAvailable(id: string): boolean {    const config = this.getComponentConfig(id)    return config ? config.enabled : false  }  /**   * 获取组件统计信息   */  getComponentStats(): {    total: number    enabled: number    disabled: number    byCategory: Record<string, number>  } {    const settings = this.getComponentSettings()    const components = Object.values(settings.components)    const stats = {      total: components.length,      enabled: components.filter((c) => c.enabled).length,      disabled: components.filter((c) => !c.enabled).length,      byCategory: {} as Record<string, number>    }    components.forEach((component) => {      stats.byCategory[component.category] = (stats.byCategory[component.category] || 0) + 1    })    return stats  }  /**   * 注册ComfyUI组件   */  registerComfyUIComponent(component: ComfyUIComponentConfig): boolean {    try {      // 验证组件配置      const validation = validateComponentConfig(component)      if (!validation.valid) {        logger.warn('Invalid ComfyUI component config:', { errors: validation.errors })        return false      }      // 检查组件ID是否已存在      const existingConfig = this.getComponentConfig(component.id)      if (existingConfig) {        logger.warn('ComfyUI component already exists:', { id: component.id })        return false      }      // 添加到组件配置中      const settings = this.getComponentSettings()      const updatedSettings: ComponentSettings = {        ...settings,        components: {          ...settings.components,          [component.id]: component        },        lastUpdated: Date.now()      }      store.dispatch(setComponentSettings(updatedSettings))      logger.info('ComfyUI component registered successfully:', { id: component.id })      return true    } catch (error) {      logger.error('Failed to register ComfyUI component:', error as Error)      return false    }  }  /**   * 获取ComfyUI组件列表   */  getComfyUIComponents(): ComfyUIComponentConfig[] {    const settings = this.getComponentSettings()    const existingComponents = Object.values(settings.components).filter(      (component): component is ComfyUIComponentConfig => component.category === 'comfyui'    )    // 不再自动创建演示组件，让用户自己创建适合其环境的组件    return existingComponents  }  /**   * 创建演示用的ComfyUI组件   */  /**   * 同步ComfyUI组件（从后端获取最新组件列表）   */  async syncComfyUIComponents(): Promise<boolean> {    try {      // 暂时跳过后端同步，直接返回成功      // TODO: 实现真正的后端同步      logger.info('ComfyUI components sync skipped (using local storage only)')      return true    } catch (error) {      logger.error('Failed to sync ComfyUI components:', error as Error)      return false    }  }  /**   * 删除ComfyUI组件   */  async deleteComfyUIComponent(id: string): Promise<boolean> {    try {      // 从后端删除      await window.api.comfyui.deleteComponent(id)      // 从本地配置中删除      const settings = this.getComponentSettings()      const updatedComponents = { ...settings.components }      delete updatedComponents[id]      const updatedSettings: ComponentSettings = {        ...settings,        components: updatedComponents,        lastUpdated: Date.now()      }      store.dispatch(setComponentSettings(updatedSettings))      logger.info('ComfyUI component deleted successfully:', { id })      return true    } catch (error) {      logger.error('Failed to delete ComfyUI component:', error as Error)      return false    }  }  /**   * 检查组件名是否可用   */  isComponentNameAvailable(componentName: string): boolean {    const components = this.getComfyUIComponents()    return !components.some((component) => component.componentName === componentName)  }  /**   * 诊断ComfyUI组件问题   */  async diagnoseComfyUIComponent(componentName: string): Promise<{    componentExists: boolean    componentConfig?: ComfyUIComponentConfig    issues: string[]    suggestions: string[]    allComponents: Array<{ name: string; componentName: string; enabled: boolean }>  }> {    const issues: string[] = []    const suggestions: string[] = []    // 获取所有组件    const components = this.getComfyUIComponents()    const allComponents = components.map((c) => ({      name: c.name,      componentName: c.componentName,      enabled: c.enabled    }))    // 查找指定组件    const component = components.find((c) => c.componentName === componentName)    if (!component) {      issues.push(`组件 "${componentName}" 不存在`)      suggestions.push('请检查组件名称是否正确')      if (components.length > 0) {        const availableNames = components.map((c) => c.componentName).join(', ')        suggestions.push(`可用的组件: ${availableNames}`)      } else {        suggestions.push('当前没有可用的ComfyUI组件，请先创建组件')      }      return {        componentExists: false,        issues,        suggestions,        allComponents      }    }    // 检查组件配置    if (!component.enabled) {      issues.push('组件已禁用')      suggestions.push('请在设置中启用该组件')    }    if (!component.serverUrl) {      issues.push('组件缺少服务器URL配置')      suggestions.push('请配置ComfyUI服务器地址')    }    if (!component.workflowTemplate || Object.keys(component.workflowTemplate).length === 0) {      issues.push('组件缺少工作流模板')      suggestions.push('请上传并配置工作流JSON文件')    }    if (!component.parameters || component.parameters.length === 0) {      issues.push('组件缺少参数配置')      suggestions.push('请配置组件参数')    }    return {      componentExists: true,      componentConfig: component,      issues,      suggestions,      allComponents    }  }  // ==================== JS组件管理方法 ====================  /**   * 获取JS组件列表   */  getJSComponents(): JSComponentConfig[] {    const settings = this.getComponentSettings()    return Object.values(settings.components).filter(      (component): component is JSComponentConfig => component.category === 'javascript'    )  }  /**   * 注册JS组件   */  registerJSComponent(component: JSComponentConfig): boolean {    try {      // 验证组件配置      const validation = validateComponentConfig(component)      if (!validation.valid) {        logger.warn('Invalid JS component config:', { errors: validation.errors })        return false      }      // 检查组件ID是否已存在      const existingConfig = this.getComponentConfig(component.id)      if (existingConfig) {        logger.warn('JS component already exists:', { id: component.id })        return false      }      // 添加到组件配置中      const settings = this.getComponentSettings()      const updatedSettings: ComponentSettings = {        ...settings,        components: {          ...settings.components,          [component.id]: component        },        lastUpdated: Date.now()      }      store.dispatch(setComponentSettings(updatedSettings))      logger.info('JS component registered successfully:', { id: component.id })      return true    } catch (error) {      logger.error('Failed to register JS component:', error as Error)      return false    }  }  /**   * 同步JS组件（从后端获取最新组件列表）   */  async syncJSComponents(): Promise<boolean> {    try {      const components = await window.api.jscomponent.getComponents()      // 更新本地配置      const settings = this.getComponentSettings()      const updatedComponents = { ...settings.components }      // 移除旧的JS组件      Object.keys(updatedComponents).forEach((id) => {        if (updatedComponents[id].category === 'javascript') {          delete updatedComponents[id]        }      })      // 添加新的JS组件      components.forEach((component) => {        updatedComponents[component.id] = component      })      const updatedSettings: ComponentSettings = {        ...settings,        components: updatedComponents,        lastUpdated: Date.now()      }      store.dispatch(setComponentSettings(updatedSettings))      logger.info('JS components synced successfully', { count: components.length })      return true    } catch (error) {      logger.error('Failed to sync JS components:', error as Error)      return false    }  }  /**   * 删除JS组件   */  async deleteJSComponent(id: string): Promise<boolean> {    try {      // 从后端删除      await window.api.jscomponent.deleteComponent(id)      // 从本地配置中删除      const settings = this.getComponentSettings()      const updatedComponents = { ...settings.components }      delete updatedComponents[id]      const updatedSettings: ComponentSettings = {        ...settings,        components: updatedComponents,        lastUpdated: Date.now()      }      store.dispatch(setComponentSettings(updatedSettings))      logger.info('JS component deleted successfully:', { id })      return true    } catch (error) {      logger.error('Failed to delete JS component:', error as Error)      return false    }  }  /**   * 检查JS组件名是否可用   */  isJSComponentNameAvailable(componentName: string): boolean {    const components = this.getJSComponents()    return !components.some((component) => component.componentName === componentName)  }  /**   * 执行JS组件   */  async executeJSComponent(componentId: string, parameters: Record<string, any>): Promise<JSComponentResult> {    try {      return await window.api.jscomponent.execute(componentId, parameters)    } catch (error) {      logger.error('Failed to execute JS component:', error as Error)      return {        success: false,        error: error instanceof Error ? error.message : String(error),        type: 'text',        executionTime: 0      }    }  }  // ==================== 导出导入功能 ====================  /**   * 导出单个组件   */  async exportComponent(componentId: string): Promise<boolean> {    try {      const component = this.getComponentConfig(componentId)      if (!component) {        logger.error('Component not found:', { componentId })        window.toast.error('组件不存在')        return false      }      // 确定组件类型      const type = component.category === 'javascript' ? 'js' : 'comfyui'      // 生成导出数据      const exportData = exportComponentToJSON(component, type)      // 生成文件名      const fileName = getExportFileName(component)      // 保存文件      await window.api.file.save(fileName, exportData, {        filters: [{ name: 'JSON Files', extensions: ['json'] }]      })      window.toast.success('组件导出成功')      logger.info('Component exported successfully:', { componentId })      return true    } catch (error) {      logger.error('Failed to export component:', error as Error)      window.toast.error('导出失败: ' + (error as Error).message)      return false    }  }  /**   * 导入组件   */  async importComponent(): Promise<ImportResult> {    try {      // 选择文件      const result = await window.api.file.open({        filters: [{ name: 'JSON Files', extensions: ['json'] }]      })      if (!result) {        return { success: false, error: '未选择文件' }      }      // 解析文件      const importData = parseImportFile(result.content)      // 验证数据格式      const validation = validateImportData(importData)      if (!validation.valid) {        const errorMsg = validation.errors.join(', ')        window.toast.error('文件格式错误: ' + errorMsg)        return { success: false, error: errorMsg }      }      // 检查冲突      const conflicts = checkComponentConflicts(importData.component, importData.type)      if (conflicts.length > 0) {        const action = await this.showConflictDialog(importData.component, conflicts)        if (action === 'cancel') {          return { success: false, error: '用户取消导入' }        }        if (action === 'rename') {          // 生成新的ID和组件名称          importData.component.id = generateNewId(importData.component.id)          if ('componentName' in importData.component) {            importData.component.componentName = generateNewComponentName(              importData.component.componentName,              importData.type            )          }        }      }      // 保存组件      if (importData.type === 'js') {        await window.api.jscomponent.createComponent(importData.component as JSComponentConfig)        await this.syncJSComponents()      } else {        // ComfyUI组件导入逻辑        const settings = this.getComponentSettings()        const updatedSettings = {          ...settings,          components: {            ...settings.components,            [importData.component.id]: importData.component          },          lastUpdated: Date.now()        }        this.updateComponentSettings(updatedSettings)      }      window.toast.success('组件导入成功')      logger.info('Component imported successfully:', { id: importData.component.id })      return {        success: true,        imported: importData.component,        warnings: validation.warnings      }    } catch (error) {      const errorMsg = error instanceof Error ? error.message : String(error)      logger.error('Failed to import component:', error as Error)      window.toast.error('导入失败: ' + errorMsg)      return { success: false, error: errorMsg }    }  }  /**   * 显示冲突处理对话框   */  private async showConflictDialog(    component: JSComponentConfig | ComfyUIComponentConfig,    conflicts: any[]  ): Promise<ConflictAction> {    return new Promise((resolve) => {      const conflictMsg = `组件 "${component.name}" 存在冲突:\n${conflicts.map((c) => `- ${c.conflictType}: ${c.componentName}`).join('\n')}\n\n请选择处理方式:`      // 简单的确认对话框，后续可以用更好的UI组件替换      if (window.confirm(conflictMsg + '\n\n点击"确定"覆盖现有组件，点击"取消"重命名导入')) {        resolve('overwrite')      } else {        if (window.confirm('是否重命名导入？点击"取消"将停止导入。')) {          resolve('rename')        } else {          resolve('cancel')        }      }    })  }}// 导出单例实例export const componentService = ComponentService.getInstance()// 在开发环境下暴露到全局作用域以便调试if (import.meta.env.DEV) {  ;(window as any).componentService = componentService}
